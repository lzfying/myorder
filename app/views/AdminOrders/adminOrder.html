<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="@{'/public/jquery-easyui/themes/easyui.css'}">
<link rel="stylesheet" type="text/css" href="@{'/public/jquery-easyui/themes/icon.css'}">
<script type="text/javascript" src="@{'/public/javascripts/jquery-2.0.0.min.js'}"></script>
<script type="text/javascript" src="@{'/public/javascripts/jquery.easyui.min.js'}"></script>
<script type="text/javascript" src="@{'/public/javascripts/easyui-lang-zh_CN.js'}"></script>
</head>
<body>
	<table id="orderdatas" class="easyui-datagrid" style="border: false; width: auto; height: auto" data-options="pagination:true,singleSelect:true,url:'/admin/order/getorders',method:'get',toolbar:'#tb'">
		<thead>
			<tr>
			    <th data-options="field:'ck',checkbox:true"></th>
				<th data-options="field:'ordernum',width:150,align:'center'">订单编号</th>
				<th data-options="field:'date',width:130,align:'center'">下单时间</th>
				<th data-options="field:'orderprice',width:80,align:'center'">订单价格</th>
				<th data-options="field:'address',width:240,align:'center'">送餐地址</th>
                <th data-options="field:'name',width:80,align:'center'">联系人</th>
				<th data-options="field:'tel',width:100,align:'center'">联系电话</th>
				<th data-options="field:'content',width:100,align:'center'">内容</th>
				<th data-options="field:'orderstate',width:60,align:'center'">订单状态</th>
				<th data-options="field:'others',width:200,align:'center'">备注</th>
			</tr>
		</thead>
	</table>
	<div id="tb" style="border: false; padding: 5px; height: auto">
		<div style="margin-bottom: 5px">
			<a id="add" class="easyui-linkbutton" iconCls="icon-add" plain="true"></a>
			<a id="edit" class="easyui-linkbutton" iconCls="icon-edit" plain="true"></a> 
			<a id="delete" class="easyui-linkbutton" iconCls="icon-remove" plain="true"></a>
			订单日期: <input id="startdate" class="easyui-datebox" style="width: 80px">
            至: <input id="enddate" class="easyui-datebox" style="width: 80px">
            <a id="query" class="easyui-linkbutton" iconCls="icon-search">查询</a>
		</div>
	</div>
	<div id="editdialog" style="padding:5px;width:600px;height:auto;top:100px" closed="true">
	   #{form @AdminOrders.saveOrder(), id:'orderform'}
            <table cellpadding="5">
                <tr>
                    <td>订单编号：</td>
                    <td><input id="ordernum" class="easyui-validatebox textbox" type="text" name="order.orderNum" data-options="required:true" style="width:150px" readonly="readonly" /></td>
                    <td>下单时间:</td>
                    <td><input id="ordertime" type="text" name="order.date" data-options="required:true" style="width:150px"></td>
                </tr>
                <tr>
                    <td>订单价格:</td>
                    <td><input class="easyui-validatebox textbox" type="text" name="order.orderPrice" data-options="required:true" style="width:150px"></input></td>
                    <td>联系人：</td>
                    <td><input class="easyui-validatebox textbox" type="text" name="order.receiver_name" data-options="required:true" style="width:150px"></input></td>
                </tr>
                <tr>
                    <td>联系电话:</td>
                    <td><input class="easyui-validatebox textbox" type="text" name="order.receiver_tel" data-options="required:true" style="width:150px"></input></td>
                    <td>备注:</td>
                    <td><input class="easyui-validatebox textbox" type="text" name="order.receiver_other" data-options="required:true" style="width:150px"></input></td>
                </tr>
                <tr>
                <td>送餐地址</td>
                <td colspan="3"><select class="easyui-combobox" name="orderarea">
                        <option value="370199">高新区</option>
                        <option value="370102">历下区</option>
                    </select>
                    <input name="order.receiver_addr" class="easyui-validatebox textbox" type="text" name="subject" data-options="required:true" style="width:300px"></input>
                </td>
                </tr>
            </table>
            <table id="meals" class="easyui-datagrid" style="border: false; width: auto; height: auto" data-options="title:'菜品列表',idField:'id',pagination:true,singleSelect:false,url:'/admin/meal/getMeals',method:'get'">
                <thead>
                    <tr>
                        <th data-options="field:'ck',checkbox:true"></th>
                        <th data-options="field:'name',width:150,align:'center'">菜品名称</th>
                        <th data-options="field:'type',width:130,align:'center'">类别</th>
                        <th data-options="field:'price',width:50,align:'center'">价格</th>
                        <th data-options="field:'discount',width:130,align:'center'">折扣</th>
                        <!-- 
                        <th data-options="field:'num', width:30, align:'center', editor:{type:'numberbox'}">数量</th>
                         -->
                    </tr>
                </thead>
            </table>
			<table id="combos" class="easyui-datagrid" style="border: false; width: auto; height: auto" data-options="title:'套餐列表',idField:'id',pagination:true,singleSelect:false,url:'/admin/combo/getCombos',method:'get'">
			        <thead>
			            <tr>
			                <th data-options="field:'ck',checkbox:true"></th>
			                <th data-options="field:'name',width:150,align:'center'">套餐名称</th>
			                <th data-options="field:'price',width:50,align:'center'">价格</th>
			                <th data-options="field:'discount',width:130,align:'center'">折扣</th>
			                <th data-options="field:'meals',width:240,align:'center'">套餐内容</th>
			            </tr>
			        </thead>
			    </table>
        #{/form}
    </div> 
	<script type="text/javascript">
		$("#add").click(function() {
			$.ajax({
				url:'/admin/order/getOrderPaymentid',
				type:'GET',
				success:function(data) {
	                $('#orderform').form('clear');
					var obj = JSON.parse(data);
					$('#orderform').form('load',{
                        'order.orderNum':obj.paymentid
                    });
					
			        $('#ordertime').datetimebox({
			        	value:obj.date,
			            required: true,
			            showSeconds: true
			        });
				},  
                error:function(){  
                    alert("获取订单编号失败，请重试！");  
                }
			});
			$('#editdialog').dialog('open');
		});
		
		$("#edit").click(function() {
			var rows = $('#orderdatas').datagrid('getSelections');
			if (rows.length == 0) {
				alert("请先选择需要编辑的订单！")
			}
			var id = "id=" + rows[0].ordernum;
			$.ajax({
                url:'/admin/order/getOrderInfo',  
                type:'GET',
                data:id,
                success:function(data){
                    var NowTime=new Date().toLocaleTimeString();
                    $('#ordertime').datetimebox({
                        value: NowTime,
                        required: true,
                        showSeconds: true
                    });
                	var obj = JSON.parse(data);
                	$('#orderform').form('load',{
                		'order.date':obj.date,
                		'order.orderPrice':obj.orderprice,
                		'order.receiver_name':obj.name,
                		'order.receiver_tel':obj.tel,
                		'order.receiver_other':obj.others,
                		'order.receiver_addr':obj.address
                    });
                	$("#editdialog").dialog("open");
                	
                },  
                error:function() {  
                    alert("编辑失败，请重试！");  
                }  
            });
		});
	
		$("#delete").click(function() {
			var rows = $('#orderdatas').datagrid('getSelections');
			var ids = "";
			for(var i=0; i<rows.length; i++){
				ids += "id="+ rows[i].orderid
				if (i != rows.length - 1) {
					ids+="&"
				}
            }
			
 			$.ajax({
                url:'/admin/order/deleteOrder',  
                type:'POST',
                data:ids,  
                success:function(data){  
                    $("#editdialog").dialog("close");
                    $("#orderdatas").datagrid("reload");
                    alert("提交成功！");
                },  
                error:function(){  
                    alert("提交失败，请重试！");  
                }  
            });
		});
		
		$("#query").click(function() {
			startdate=$('#startdate').datebox("getValue");
			enddate=$('#enddate').datebox("getValue");
			$('#orderdatas').datagrid('load', { 
				startdate: startdate,
				enddate: enddate 
		    });
		});
		
		$('#editdialog').dialog({
			title : '订单编辑',
			buttons : [
			{
				text : '保存',
				iconCls : 'icon-save',
				handler : function() {
//					$('#orderform').submit();
                    var mealrows = $('#meals').datagrid('getSelections');
                    var comborows = $('#combos').datagrid('getSelections');
                    if (mealrows.length == 0 || comborows.length == 0) {
                        alert("请选择菜品！")
                    }
                    var mealids = "";
                    for(var i=0; i<mealrows.length; i++){
                        mealids += "mealid="+ mealrows[i].id;
                        if (i != mealrows.length - 1) {
                        	mealids+="&";
                        }
                    }
                    var comboids = "&";
                    for(var i=0; i<comborows.length; i++){
                    	comboids += "comboid="+ comborows[i].id;
                        if (i != comborows.length - 1) {
                        	comboids+="&";
                        }
                    }
                    
                    
                    var form = $("#orderform"); 
                    $.ajax({  
                        url:form.attr('action'),  
                        type:form.attr('method'),  
                        data:form.serialize() + mealids + comboids,  
                        success:function(data){  
                            $("#editdialog").dialog("close");
                            $("#orderdatas").datagrid("reload");
                            alert("提交成功！");
                        },  
                        error:function(){  
                            alert("提交失败，请重试！");  
                        }  
                    });
				}
			}, {
				text : '取消',
				iconCls : 'icon-cancel',
				handler : function() {
					$('#editdialog').dialog('close');
				}
			}]
		});
		
		
	</script>
</body>
</html>